<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Planner - Upgraded Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
Â  body { font-family: 'Inter', sans-serif; }
Â  header {
Â  Â  background: linear-gradient(270deg, #7c3aed, #06b6d4, #8b5cf6);
Â  Â  background-size: 600% 600%;
Â  Â  animation: gradientBG 12s ease infinite;
Â  Â  color: white; border-radius: 1.5rem; box-shadow: 0 8px 30px rgba(124, 58, 237, 0.2);
Â  }
Â  @keyframes gradientBG {
Â  Â  0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
Â  }
Â  /* --- REFINED HOVER EFFECT --- */
Â  .card-hover, button, input, select, textarea {
Â  Â  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
Â  }
Â  .card-hover:hover {
Â  Â  box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.2), 0 8px 10px -6px rgba(124, 58, 237, 0.1);
Â  }
Â  button:hover:not(:disabled) {
Â  Â  transform: scale(1.03); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
Â  }
Â  input:focus, select:focus, textarea:focus {
Â  Â  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3); border-color: #8b5cf6;
Â  }
Â  .goals-list::-webkit-scrollbar, .messages-container::-webkit-scrollbar, .monthly-goals-list::-webkit-scrollbar { width: 8px; }
Â  .goals-list::-webkit-scrollbar-track, .messages-container::-webkit-scrollbar-track, .monthly-goals-list::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 12px; }
Â  .goals-list::-webkit-scrollbar-thumb, .messages-container::-webkit-scrollbar-thumb, .monthly-goals-list::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 12px; }
Â  .goal-item:hover .delete-goal-btn, .goal-item:hover .copy-to-daily-btn { opacity: 1; transform: scale(1); }
Â  .calendar-day.has-tasks { background-color: #e0e7ff; font-weight: 600; }
Â  .calendar-day.is-today { box-shadow: 0 0 0 2px #7c3aed; border-radius: 0.5rem; }
Â  .timer-running { animation: pulse 2.5s infinite ease-in-out; }
Â  .timer-display { font-family: 'Courier New', monospace; font-weight: 700; letter-spacing: 0.5px; }
Â  @keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.6; } }
Â  .play-btn, .stop-btn { width: 34px; height: 34px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
Â  .play-btn { background-color: #10b981; color: white; }
Â  .stop-btn { background-color: #ef4444; color: white; }
Â  .delete-goal-btn, .copy-to-daily-btn { opacity: 0; transform: scale(0.8); transition: all 0.3s ease; }
Â  .message { background-color: #f1f5f9; padding: 0.75rem 1rem; border-radius: 1.25rem; max-width: 85%; }
Â  .message.sent { background-color: #e0e7ff; align-self: flex-end; border-bottom-right-radius: 0.5rem; }
Â  .message.received { border-bottom-left-radius: 0.5rem; }
Â  .link-bubble { color:#0f172a; text-decoration:underline; font-weight: 500; }
Â  .fade-in { animation: fadeIn 0.5s ease-out both; }
Â  .fade-out { animation: fadeOut 0.4s ease-out forwards; }
Â  @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
Â  @keyframes fadeOut { from{opacity:1; transform: scale(1);} to{opacity:0; transform: scale(0.95);} }

Â  /* --- NEW STYLES FOR TASK UI --- */
Â  .subject-header {
Â  Â  Â  font-size: 1.1rem; font-weight: 700; color: #4338ca; margin-top: 1rem; margin-bottom: 0.5rem;
Â  Â  Â  padding-bottom: 0.25rem; border-bottom: 2px solid #e0e7ff;
Â  }
Â  .subject-tag {
Â  Â  Â  font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px;
Â  Â  Â  color: white; display: inline-block; margin-right: 8px;
Â  }
Â  .task-description {
Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  font-size: 0.875rem; color: #475569; background-color: #f8fafc;
Â  Â  Â  padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem;
Â  Â  Â  border-left: 3px solid #a78bfa; white-space: pre-wrap;
Â  }
Â  .task-description.is-visible { display: block; }
Â  .description-toggle-btn {
Â  Â  Â  cursor: pointer; color: #94a3b8; font-weight: bold;
Â  Â  Â  width: 20px; height: 20px; border-radius: 50%; display: flex;
Â  Â  Â  align-items: center; justify-content: center;
Â  }
Â  .description-toggle-btn:hover { background-color: #e2e8f0; color: #4f46e5; }
</style>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="container mx-auto max-w-7xl px-4 sm:px-6 py-8">

Â  <header class="text-center mb-8 p-6 md:p-8">
    Â  Â  <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-2">Study Planner</h1>
Â  Â  <p class="text-indigo-100 font-medium text-base md:text-lg mb-2">Made by Radhika ðŸš€</p>
Â  Â  <div class="text-sm text-indigo-200">Daily & Monthly Goals, Timers, and Messenger.</div>
Â  </header>

Â  <div id="members-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"></div>
Â  <div id="loader" class="text-center py-10 text-slate-500">Authenticating...</div>
Â  <div id="empty-state-members" class="hidden text-center py-10 bg-white rounded-2xl shadow-lg">
Â  Â  <p class="text-indigo-500 font-semibold">No members yet. Be the first to join below!</p>
Â  </div>

Â  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-10">
Â  Â  <div class="xl:col-span-1">
Â  Â  Â  Â  <div id="master-calendar-container" class="bg-white p-6 rounded-3xl shadow-xl card-hover h-full"></div>
Â  Â  </div>
Â  Â  <div class="xl:col-span-2">
Â  Â  Â  Â  <div id="monthly-goals-container" class="bg-white p-6 rounded-3xl shadow-xl card-hover h-full"></div>
Â  Â  </div>
Â  </div>

Â  <div id="messenger-section" class="bg-white p-6 rounded-3xl shadow-xl mb-10 card-hover">
Â  Â  <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Group Messenger</h2>
Â  Â  <div class="flex items-center gap-3 mb-4 flex-wrap">
Â  Â  Â  Â  <label for="messenger-user-select" class="font-semibold text-indigo-600">I am:</label>
Â  Â  Â  Â  <select id="messenger-user-select" class="p-2 border border-indigo-300 rounded-lg">
Â  Â  Â  Â  Â  Â  <option value="">-- Select your name --</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div id="messages-container" class="messages-container h-64 overflow-y-auto p-4 bg-slate-50 rounded-xl mb-4 flex flex-col gap-4"></div>
Â  Â  <div class="flex flex-col sm:flex-row gap-3">
Â  Â  Â  Â  <input type="text" id="message-input" placeholder="Type a message or paste a link..." class="flex-grow p-3 border border-indigo-300 rounded-xl" />
Â  Â  Â  Â  <button id="send-message-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md">Send</button>
Â  Â  </div>
Â  </div>

Â  <div class="bg-white p-6 rounded-3xl shadow-xl card-hover">
Â  Â  <h2 class="text-2xl font-semibold mb-5 text-indigo-700">Add a New Member</h2>
Â  Â  <div class="flex flex-col sm:flex-row gap-4 items-center">
Â  Â  Â  <input type="text" id="new-member-name-input" placeholder="Enter your name" class="flex-grow p-3 border border-indigo-300 rounded-xl" />
Â  Â  Â  <button id="add-member-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-md">Add Me</button>
Â  Â  </div>
Â  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, runTransaction, query, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
Â  Â  apiKey: "AIzaSyC8zXcbDNwdm2LMbpzV1KkN3wiTyh_vZ3M",
Â  Â  authDomain: "o-study-f5081.firebaseapp.com",
Â  Â  projectId: "o-study-f5081",
Â  Â  storageBucket: "o-study-f5081.appspot.com",
Â  Â  messagingSenderId: "338420264881",
Â  Â  appId: "1:338420264881:web:c4119859174ab264709790"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- OneSignal Initialization ---
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
Â  Â  OneSignal.init({
Â  Â  Â  Â  appId: "3908e089-73c0-40d4-9f2c-733204a82a01",
Â  Â  Â  Â  safari_web_id: "web.onesignal.auto.123456-7890ab-cdef-1234",
Â  Â  Â  Â  allowLocalhostAsSecureOrigin: true,
Â  Â  });
});

// --- Constants ---
const INITIAL_MONTHLY_TASKS = [
Â  Â  "Anatomy (LE): Blood Supply of Heart", "Anatomy (LE): Brachial Plexus", "Anatomy (LE): Femoral Triangle", "Anatomy (LE): Hip Joint", "Anatomy (LE): Ischiorectal Fossa", "Anatomy (LE): Knee Joint", "Anatomy (LE): Mammary Gland", "Anatomy (LE): Muscles of Mastication", "Anatomy (LE): Pancreas", "Anatomy (LE): Right Atrium", "Anatomy (LE): Sciatic Nerve", "Anatomy (LE): Shoulder Joint", "Anatomy (LE): Thyroid Gland", "Anatomy (LE): Urinary Bladder", "Anatomy (LE): Uterus",
Â  Â  "Anatomy (SE): Adductor Canal", "Anatomy (SE): Axillary Artery", "Anatomy (SE): Azygos Vein", "Anatomy (SE): Blood Supply of Stomach", "Anatomy (SE): Bronchopulmonary Segments", "Anatomy (SE): Caecum", "Anatomy (SE): Cavernous Sinus", "Anatomy (SE): Ciliary Ganglion", "Anatomy (SE): Circle of Willis", "Anatomy (SE): Clavipectoral Fascia", "Anatomy (SE): Corpus Callosum", "Anatomy (SE): Cubital Fossa", "Anatomy (SE): Deltoid Muscle", "Anatomy (SE): Development of Pancreas", "Anatomy (SE): Development of Spleen", "Anatomy (SE): Development of Tongue", "Anatomy (SE): Dorsalis Pedis Artery", "Anatomy (SE): Epiploic Foramen", "Anatomy (SE): Falx Cerebri", "Anatomy (SE): Femoral Sheath", "Anatomy (SE): Inferior Cerebellar Peduncle", "Anatomy (SE): Microscopic structure of Duodenum", "Anatomy (SE): Microscopic structure of Palatine Tonsil", "Anatomy (SE): Microscopic structure of Pancreas", "Anatomy (SE): Microscopic Structure of Ovary", "Anatomy (SE): Notochord", "Anatomy (SE): Pectoralis Major", "Anatomy (SE): Pelvic Diaphragm", "Anatomy (SE): Portal Vein", "Anatomy (SE): Portocaval Anastomosis", "Anatomy (SE): Prostate", "Anatomy (SE): Supports of Uterus", "Anatomy (SE): Thoracic Duct",
Â  Â  "Anatomy (SA): Barr Body", "Anatomy (SA): Cephalic Vein", "Anatomy (SA): Coracoid Process", "Anatomy (SA): Derivatives of Mesonephric Duct", "Anatomy (SA): Derivatives of Midgut", "Anatomy (SA): Dermatome", "Anatomy (SA): Development of Uterus", "Anatomy (SA): External Jugular Vein", "Anatomy (SA): Filum Terminale", "Anatomy (SA): First Rib", "Anatomy (SA): Innervation of Tongue", "Anatomy (SA): Ligaments of Spleen", "Anatomy (SA): Median Nerve in Carpal Tunnel", "Anatomy (SA): Nerve Supply of Urinary Bladder", "Anatomy (SA): Palmar Aponeurosis", "Anatomy (SA): Positions of Appendix", "Anatomy (SA): Sternal Angle",
Â  Â  "Physiology (LE): Formation of Urine", "Physiology (LE): Regulation of Cardiac Output", "Physiology (LE): Mechanism of Blood Coagulation", "Physiology (LE): Plasma Proteins", "Physiology (LE): Hypoxia", "Physiology (LE): ECG", "Physiology (LE): Regulation of Blood Pressure", "Physiology (LE): Cardiac Cycle", "Physiology (LE): Thyroid Hormones", "Physiology (LE): Regulation of Menstrual Cycle", "Physiology (LE): Muscle Spindle and Muscle Tone", "Physiology (LE): Basal Ganglia", "Physiology (LE): Neuromuscular Junction", "Physiology (LE): Pain Pathway", "Physiology (LE): Growth Hormone", "Physiology (LE): Calcium Homeostasis",
Â  Â  "Physiology (SE): Rennin-Angiotensin Mechanism", "Physiology (SE): Complications of Mismatched Blood Transfusion", "Physiology (SE): Deglutition Reflex", "Physiology (SE): Oxygen-Dissociation Curve", "Physiology (SE): Functions of Stomach", "Physiology (SE): Active Transport", "Physiology (SE): Chloride Shift", "Physiology (SE): Glomerular Filtration Rate (GFR)", "Physiology (SE): P-R Interval", "Physiology (SE): Sino-Aortic Reflex", "Physiology (SE): Functions of Plasma Proteins", "Physiology (SE): Pulmonary Surfactant", "Physiology (SE): UMN and LMN Lesion", "Physiology (SE): Refractive Errors of the Eye", "Physiology (SE): Functions of Middle Ear", "Physiology (SE): Referred Pain", "Physiology (SE): Stretch Reflex", "Physiology (SE): Spermatogenesis", "Physiology (SE): Visual Pathway", "Physiology (SE): Cushing's Syndrome", "Physiology (SE): Endometrial changes during Menstrual Cycle", "Physiology (SE): Actions of Insulin", "Physiology (SE): Functions of Hypothalamus", "Physiology (SE): Functions of Cerebellum",
Â  Â  "Physiology (SA): Triple Response", "Physiology (SA): Cheyne-Stokes Respiration", "Physiology (SA): Vagal Tone", "Physiology (SA): Alkaline Tide", "Physiology (SA): Juxtaglomerular Apparatus", "Physiology (SA): Facilitated Diffusion", "Physiology (SA): Cyanosis", "Physiology (SA): Heart Sounds", "Physiology (SA): Cretinism / Myxoedema", "Physiology (SA): Saltatory Conduction", "Physiology (SA): Inhibin", "Physiology (SA): Oxytocin", "Physiology (SA): Taste Pathway", "Physiology (SA): Acromegaly", "Physiology (SA): Functions of ADH", "Physiology (SA): Aphasia", "Physiology (SA): Babinski's Sign", "Physiology (SA): Renshaw Cell Inhibition",
Â  Â  "Biochemistry (LE): Citric Acid Cycle (TCA Cycle)", "Biochemistry (LE): Metabolism of Phenylalanine and Tyrosine", "Biochemistry (LE): Regulation of Blood Calcium Level", "Biochemistry (LE): Protein Biosynthesis (Translation)", "Biochemistry (LE): Recombinant DNA Technology", "Biochemistry (LE): Catabolism of Purine Nucleotides",
Â  Â  "Biochemistry (SE): Fatty Liver and Lipotropic Factors", "Biochemistry (SE): Urea Cycle", "Biochemistry (SE): Glycogenolysis", "Biochemistry (SE): Competitive Inhibition", "Biochemistry (SE): Antioxidants", "Biochemistry (SE): Metabolic changes in Diabetes Mellitus", "Biochemistry (SE): Glycogenesis", "Biochemistry (SE): Cell Membrane", "Biochemistry (SE): Compounds derived from Cholesterol", "Biochemistry (SE): Renal Mechanisms in Acid Base Balance", "Biochemistry (SE): Genetic Code", "Biochemistry (SE): Catabolism of Purines", "Biochemistry (SE): Formation of Bilirubin", "Biochemistry (SE): Metabolic Acidosis", "Biochemistry (SE): Basal Metabolic Rate (BMR)", "Biochemistry (SE): Polymerase Chain Reaction (PCR)", "Biochemistry (SE): Porphyrias",
Â  Â  "Biochemistry (SA): Oncogenes", "Biochemistry (SA): Uncouplers of Oxidative Phosphorylation", "Biochemistry (SA): Significance of HMP Pathway", "Biochemistry (SA): Tumor Markers", "Biochemistry (SA): Essential Amino Acids", "Biochemistry (SA): Endoplasmic Reticulum", "Biochemistry (SA): Creatinine Clearance Test", "Biochemistry (SA): Dietary Fiber", "Biochemistry (SA): Gout"
];

// --- State Management ---
let allMembersData = [];
const memberViewStates = {};
let calendarDate = new Date();
const timerIntervals = {};
let currentMessengerId = localStorage.getItem('currentMessengerId') || '';

// --- Utility Functions ---
const getLocalDateString = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
const getYearMonthString = (date) => date.toISOString().slice(0, 7);
const TODAY_STRING = getLocalDateString(new Date());
const formatTime = (ms) => {
Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  const m = Math.floor(totalSeconds / 60);
Â  Â  const s = totalSeconds % 60;
Â  Â  return `${m}:${s.toString().padStart(2, '0')}`;
}
const getTotalTimeSpent = (goal) => (goal.totalTime || 0) + (goal.isRunning && goal.startTime ? Date.now() - goal.startTime : 0);
const getInitials = (name) => (name || 'U').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
const pickColorForName = (name, saturation = 60, lightness = 50) => {
Â  Â  let hash = 0;
Â  Â  for (let i = 0; i < (name || '').length; i++) {
Â  Â  Â  Â  hash = name.charCodeAt(i) + ((hash << 5) - hash);
Â  Â  Â  Â  hash |= 0;Â 
Â  Â  }
Â  Â  return `hsl(${hash % 360}, ${saturation}%, ${lightness}%)`;
};
const groupTasksBySubject = (tasks) => {
Â  Â  return (tasks || []).reduce((acc, task) => {
Â  Â  Â  Â  const subject = task.subject || 'General';
Â  Â  Â  Â  if (!acc[subject]) acc[subject] = [];
Â  Â  Â  Â  acc[subject].push(task);
Â  Â  Â  Â  return acc;
Â  Â  }, {});
};

// --- Push Notification Functions ---
function identifyUserInOneSignal(yourInternalUserId) {
Â  Â  if (!yourInternalUserId || !window.OneSignal) return;
Â  Â  window.OneSignal.push(() => {
Â  Â  Â  Â  OneSignal.setExternalUserId(yourInternalUserId);
Â  Â  });
}

// --- DOM Rendering ---
function renderApp() {
Â  Â  renderMasterCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
Â  Â  updateMembersUI(allMembersData);
Â  Â  renderSharedMonthlyView();
Â  Â  updateMessengerUserSelect();
}

function renderMasterCalendar(year, month) {
Â  Â  const tasksByDate = {};
Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  Object.entries(member.dailyTasks || {}).forEach(([date, tasks]) => {
Â  Â  Â  Â  Â  Â  tasksByDate[date] = (tasksByDate[date] || 0) + tasks.length;
Â  Â  Â  Â  });
Â  Â  });
Â  Â  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
Â  Â  const firstDay = new Date(year, month, 1).getDay();
Â  Â  const daysInMonth = new Date(year, month + 1, 0).getDate();
Â  Â  const calendarHtml = `
Â  Â  <div class="flex items-center justify-between mb-4 px-2">
Â  Â  Â  <button id="prev-month-btn" class="p-2 rounded-full hover:bg-indigo-100">&lt;</button>
Â  Â  Â  <h2 class="text-xl font-bold text-indigo-700">${monthNames[month]} ${year}</h2>
Â  Â  Â  <button id="next-month-btn" class="p-2 rounded-full hover:bg-indigo-100">&gt;</button>
Â  Â  </div>
Â  Â  <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-indigo-500 px-2">
Â  Â  Â  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
Â  Â  </div>
Â  Â  <div class="grid grid-cols-7 gap-1 mt-2 px-2">${
Â  Â  Â  Â  Array(firstDay).fill('<div></div>').join('') +
Â  Â  Â  Â  Array.from({length: daysInMonth}, (_, i) => {
Â  Â  Â  Â  Â  Â  const day = i + 1;
Â  Â  Â  Â  Â  Â  const dateStr = getLocalDateString(new Date(year, month, day));
Â  Â  Â  Â  Â  Â  return `<div class="calendar-day cursor-pointer p-2 text-center rounded-lgÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ${tasksByDate[dateStr] > 0 ? 'has-tasks' : ''}Â 
Â  Â  Â  Â  Â  Â  Â  Â  ${dateStr === TODAY_STRING ? 'is-today' : ''} hover:bg-indigo-200" data-date="${dateStr}">${day}</div>`;
Â  Â  Â  Â  }).join('')
Â  Â  }</div>`;
Â  Â  document.getElementById('master-calendar-container').innerHTML = calendarHtml;
}

function updateMembersUI(members) {
Â  Â  const container = document.getElementById('members-container');
Â  Â  document.getElementById('loader').style.display = 'none';
Â  Â  document.getElementById('empty-state-members').style.display = members.length === 0 ? 'block' : 'none';
Â  Â  const memberIds = new Set(members.map(m => m.id));
Â  Â  Array.from(container.children).forEach(child => {
Â  Â  Â  Â  if (!memberIds.has(child.dataset.id)) {
Â  Â  Â  Â  Â  Â  child.classList.add('fade-out');
Â  Â  Â  Â  Â  Â  setTimeout(() => child.remove(), 400);
Â  Â  Â  Â  }
Â  Â  });
Â  Â  members.forEach((member, index) => {
Â  Â  Â  Â  let memberCard = container.querySelector(`[data-id="${member.id}"]`);
Â  Â  Â  Â  if (!memberCard) {
Â  Â  Â  Â  Â  Â  memberCard = createMemberCard(member);
Â  Â  Â  Â  Â  Â  memberCard.style.animationDelay = `${index * 100}ms`;
Â  Â  Â  Â  Â  Â  container.appendChild(memberCard);
Â  Â  Â  Â  }
Â  Â  Â  Â  updateMemberCard(memberCard, member);
Â  Â  });
}

function createMemberCard(member) {
Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-3xl shadow-lg flex flex-col fade-in';
Â  Â  card.dataset.id = member.id;
Â  Â  card.innerHTML = `
Â  Â  Â  <div class="flex justify-between items-start mb-5">
Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  <div class="avatar-container w-12 h-12 rounded-full flex items-center justify-center font-bold text-white text-xl" style="background-color:${pickColorForName(member.name)}">${getInitials(member.name)}</div>
Â  Â  Â  Â  Â  <h3 class="text-2xl font-extrabold text-indigo-800">${member.name}</h3>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="delete-member-btn text-indigo-400 hover:text-red-600 p-1" aria-label="Delete member">
Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  <div class="flex items-center gap-3 mb-5 flex-wrap">
Â  Â  Â  Â  <label class="font-semibold text-indigo-600">Date:</label>
Â  Â  Â  Â  <input type="date" class="member-date-picker p-2 border border-indigo-300 rounded-lg bg-white" />
Â  Â  Â  Â  <button class="carry-forward-btn ml-auto bg-indigo-100 text-indigo-700 text-xs font-bold py-2 px-3 rounded-lg hover:bg-indigo-200">Carry Over âž”</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="mb-5">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-1 text-sm text-indigo-600 font-semibold"><span>Daily Progress</span><span class="progress-count"></span></div>
Â  Â  Â  Â  <div class="w-full bg-indigo-200 rounded-full h-3"><div class="progress-bar bg-indigo-600 h-3 rounded-full" style="width:0%;"></div></div>
Â  Â  Â  Â  <div class="total-time-label text-xs mt-2 text-indigo-500 font-medium"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="goals-list flex-grow overflow-y-auto max-h-80 pr-2"></div>
Â  Â  Â  <div class="mt-6 pt-5 border-t space-y-3">
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="new-goal-subject-input p-3 border border-indigo-300 rounded-xl" placeholder="Subject (e.g., Anatomy)" />
Â  Â  Â  Â  Â  Â  Â  <input type="text" class="new-goal-text-input p-3 border border-indigo-300 rounded-xl" placeholder="Task name..." />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <textarea class="new-goal-desc-input w-full p-3 border border-indigo-300 rounded-xl text-sm" placeholder="Optional: Add more details..."></textarea>
Â  Â  Â  Â  Â  <button class="add-goal-btn w-full bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-800">Add Goal</button>
Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  return card;
}

function updateMemberCard(card, member) {
Â  Â  if (!memberViewStates[member.id]) memberViewStates[member.id] = { date: TODAY_STRING };
Â  Â  const state = memberViewStates[member.id];
Â  Â  renderDailyView(card, member, state.date);
}

function renderDailyView(card, member, date) {
Â  Â  card.querySelector('.member-date-picker').value = date;
Â  Â  const goalsForDate = member.dailyTasks?.[date] || [];
Â  Â  const completedTasks = goalsForDate.filter(g => g.completed).length;
Â  Â  const totalTime = goalsForDate.reduce((acc, goal) => acc + getTotalTimeSpent(goal), 0);
Â  Â  card.querySelector('.progress-count').textContent = `${completedTasks} / ${goalsForDate.length} Goals`;
Â  Â  card.querySelector('.progress-bar').style.width = goalsForDate.length > 0 ? `${(completedTasks / goalsForDate.length) * 100}%` : '0%';
Â  Â  card.querySelector('.total-time-label').textContent = `Total time today: ${formatTime(totalTime)}`;
Â  Â  renderGoalsForMember(card.querySelector('.goals-list'), member.id, date, goalsForDate);
}

function renderSharedMonthlyView() {
Â  Â  const container = document.getElementById('monthly-goals-container');
Â  Â  const listElement = container.querySelector('.monthly-goals-list');
Â  Â  const scrollPosition = listElement ? listElement.scrollTop : 0;
Â  Â  if (allMembersData.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<h2 class="text-2xl font-semibold text-purple-700">Group Monthly Goals</h2><p class="text-purple-400 text-center mt-4">Add a member to get started with monthly goals.</p>'; return;
Â  Â  }
Â  Â  const monthStr = getYearMonthString(calendarDate);
Â  Â  const sourceMember = allMembersData[0]; // Use first member as the source of truth for the list
Â  Â  const monthlyTasks = sourceMember.monthlyTasks?.[monthStr] || [];
Â  Â  let html = `<div class="flex justify-between items-center mb-5"><h2 class="text-2xl font-semibold text-purple-700">Group Monthly Goals (${new Date(monthStr+'-02').toLocaleString('default', { month: 'long' })})</h2></div><div class="space-y-4 mb-6">`;
Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  const memberMonthlyTasks = member.monthlyTasks?.[monthStr] || [];
Â  Â  Â  Â  const completedCount = memberMonthlyTasks.filter(task => task.completedBy?.[member.id]).length;
Â  Â  Â  Â  const progress = monthlyTasks.length > 0 ? (completedCount / monthlyTasks.length) * 100 : 0;
Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-1 text-sm text-purple-600 font-semibold"><span>${member.name}</span><span>${completedCount} / ${monthlyTasks.length}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full bg-purple-200 rounded-full h-2.5"><div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress}%;"></div></div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  });
Â  Â  html += `</div>`;
Â  Â  if (monthlyTasks.length === 0) {
Â  Â  Â  Â  html += '<p class="text-purple-400 p-4 text-center">No monthly goals set for this month.</p>';
Â  Â  } else {
Â  Â  Â  Â  const groupedTasks = groupTasksBySubject(monthlyTasks);
Â  Â  Â  Â  html += `<div class="monthly-goals-list flex-grow overflow-y-auto max-h-96 pr-2">`;
Â  Â  Â  Â  Object.keys(groupedTasks).sort().forEach(subject => {
Â  Â  Â  Â  Â  Â  html += `<h3 class="subject-header" style="color:#5b21b6; border-color:#ddd6fe;">${subject}</h3>`;
Â  Â  Â  Â  Â  Â  html += groupedTasks[subject].map(task => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-item p-3 rounded-xl hover:bg-purple-50 group" data-task-id="${task.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-purple-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="subject-tag" style="background-color: ${pickColorForName(task.subject || 'General', 50, 45)};">${task.subject || 'General'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${task.text}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2 ml-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${task.description ? `<button class="description-toggle-btn" title="Show description">â“˜</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="copy-to-daily-btn text-purple-400 hover:text-purple-600" title="Copy to my Daily Tasks">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 8 5zm-1.5 2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="delete-goal-btn text-purple-400 hover:text-red-500" title="Delete Monthly Goal">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-2 mt-3 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${allMembersData.map(m => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const memberTask = (m.monthlyTasks?.[monthStr] || []).find(t => t.id === task.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isChecked = memberTask?.completedBy?.[m.id] || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center gap-2 cursor-pointer p-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" class="monthly-goal-checkbox h-5 w-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" data-member-id="${m.id}" ${isChecked ? 'checked' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-slate-700">${m.name.split(' ')[0]}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  });
Â  Â  Â  Â  html += `</div>`;
Â  Â  }
Â  Â  html += `
Â  Â  Â  Â  <div class="mt-6 pt-5 border-t space-y-3">
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-monthly-goal-subject" class="flex-grow p-3 border border-purple-300 rounded-xl" placeholder="Subject (e.g., Anatomy)" />
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="new-monthly-goal-text" class="flex-grow p-3 border border-purple-300 rounded-xl" placeholder="New group goal..." />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <textarea id="new-monthly-goal-desc" class="w-full p-3 border border-purple-300 rounded-xl text-sm" placeholder="Optional: Add description..."></textarea>
Â  Â  Â  Â  Â  Â  <button id="add-monthly-goal-btn" class="w-full bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-purple-800">Add Goal</button>
Â  Â  Â  Â  </div>`;
Â  Â  container.innerHTML = html;
Â  Â  const newListElement = container.querySelector('.monthly-goals-list');
Â  Â  if (newListElement) newListElement.scrollTop = scrollPosition;
}

function renderGoalsForMember(listContainer, memberId, date, goals) {
Â  Â  if (goals.length === 0) {
Â  Â  Â  Â  listContainer.innerHTML = '<p class="text-indigo-400 p-4 text-center">No goals for this day. Add one below!</p>'; return;
Â  Â  }
Â  Â  const groupedTasks = groupTasksBySubject(goals.sort((a, b) => a.completed - b.completed));
Â  Â  let html = '';
Â  Â  Object.keys(groupedTasks).sort().forEach(subject => {
Â  Â  Â  Â  html += `<h3 class="subject-header">${subject}</h3>`;
Â  Â  Â  Â  html += groupedTasks[subject].map(goal => `
Â  Â  Â  Â  Â  Â  <div class="goal-item p-3 rounded-xl hover:bg-indigo-100 group ${goal.isRunning ? 'timer-running bg-green-50' : ''}" data-goal-id="${goal.id}" data-goal-date="${date}">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" class="goal-checkbox h-5 w-5 mt-1 rounded text-indigo-600" ${goal.completed ? 'checked' : ''} ${goal.isRunning ? 'disabled' : ''} />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ml-3 flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="${goal.completed ? 'line-through text-indigo-400' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="subject-tag" style="background-color: ${pickColorForName(goal.subject || 'General', 60, 50)};">${goal.subject || 'General'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${goal.text}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-indigo-500 timer-display ${goal.isRunning ? 'text-green-600' : ''}">${formatTime(getTotalTimeSpent(goal))}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2 ml-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${goal.description ? `<button class="description-toggle-btn" title="Show description">â“˜</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  _D Â  Â  Â  Â  ${!goal.completed ? (goal.isRunning
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<button class="stop-btn timer-control-btn" data-action="stop">â– </button>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<button class="play-btn timer-control-btn" data-action="start">â–¶</button>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-goal-btn text-indigo-400 hover:text-red-500" title="Delete Goal">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${goal.description ? `<div class="task-description">${goal.description}</div>` : ''}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `).join('');
Â  Â  });
Â  Â  listContainer.innerHTML = html;
Â  Â  goals.forEach(g => { if (g.isRunning) startTimerDisplay(memberId, date, g.id); });
}

function renderMessages(messages) {
Â  Â  const container = document.getElementById('messages-container');
Â  Â  container.innerHTML = messages.map(msg => {
Â  Â  Â  Â  const msgData = msg.data();
Â  Â  Â  Â  const isSent = msgData.senderId === currentMessengerId;
Â  Â  Â  Â  const linkRegex = /(https?:\/\/\S+)/g;
Â  Â  Â  Â  const textWithLinks = (msgData.text || '').replace(linkRegex, `<a href="$1" target="_blank" class="link-bubble">$1</a>`);
Â  Â  Â  Â  return `
Â  Â  Â  Â  <div class="message flex flex-col ${isSent ? 'sent' : 'received'} fade-in" data-id="${msg.id}">
Â  Â  Â  Â  Â  Â  <span class="font-bold text-sm text-indigo-700">${msgData.senderName}</span>
Â  Â  Â  Â  Â  Â  <p class="text-slate-800 break-words">${textWithLinks}</p>
Â  Â  Â  Â  Â  Â  <span class="text-xs text-slate-500 mt-1 self-end">${msgData.createdAt ? new Date(msgData.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</span>
Â  Â  Â  Â  </div>`;
Â  Â  }).join('');
Â  Â  container.scrollTop = container.scrollHeight;
}

function updateMessengerUserSelect() {
Â  Â  const select = document.getElementById('messenger-user-select');
Â  Â  select.innerHTML = '<option value="">-- Select your name --</option>' + allMembersData.map(member =>
Â  Â  Â  Â  `<option value="${member.id}" ${member.id === currentMessengerId ? 'selected' : ''}>${member.name}</option>`
Â  Â  ).join('');
}

// --- Data Seeding ---
async function seedInitialMonthlyTasks() {
Â  Â  const monthStr = getYearMonthString(new Date());
Â  Â  const seedFlag = `tasksSeeded_v3_${monthStr}`;
Â  Â  if (localStorage.getItem(seedFlag) || allMembersData.length === 0) return;
Â  Â  const firstMemberDoc = await getDoc(doc(db, "members", allMembersData[0].id));
Â  Â  if (firstMemberDoc.exists() && firstMemberDoc.data().monthlyTasks?.[monthStr]?.length > 0) {
Â  Â  Â  Â  localStorage.setItem(seedFlag, 'true'); return;
Â  Â  }
Â  Â  console.log("Seeding initial monthly tasks for", monthStr);
Â  Â  const newTasks = INITIAL_MONTHLY_TASKS.map(fullText => {
Â  Â  Â  Â  const match = fullText.match(/^(.*?)\s\((.*?)\):\s(.*)$/);
Â  Â  Â  Â  const subject = match ? match[1].trim() : 'General';
Â  Â  Â  Â  const text = match ? `(${match[2].trim()}) ${match[3].trim()}` : fullText;
Â  Â  Â  Â  return { id: crypto.randomUUID(), subject, text, description: '', completedBy: {} };
Â  Â  });
Â  Â  try {
Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  Â  Â  const ref = doc(db, "members", member.id);
Â  Â  Â  Â  Â  Â  batch.update(ref, { [`monthlyTasks.${monthStr}`]: newTasks });
Â  Â  Â  Â  });
Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  localStorage.setItem(seedFlag, 'true');
Â  Â  Â  Â  console.log("Successfully seeded tasks.");
Â  Â  } catch (error) { console.error("Failed to seed tasks:", error); }
}

// --- Event Handlers & Logic ---
async function handleMemberEvents(e) {
Â  const memberCard = e.target.closest('[data-id]');
Â  if (!memberCard) return;
Â  const memberId = memberCard.dataset.id;
Â  const memberDocRef = doc(db, 'members', memberId);
Â  if (e.target.matches('.member-date-picker')) {
Â  Â  memberViewStates[memberId].date = e.target.value;
Â  Â  updateMemberCard(memberCard, allMembersData.find(m => m.id === memberId));
Â  Â  return;
Â  }
Â  if (e.target.closest('.delete-member-btn')) {
Â  Â  if (confirm('Are you sure you want to delete this member?')) await deleteDoc(memberDocRef);
Â  Â  return;
Â  }
Â  if (e.target.matches('.add-goal-btn')) {
Â  Â  const subjectInput = memberCard.querySelector('.new-goal-subject-input');
Â  Â  const textInput = memberCard.querySelector('.new-goal-text-input');
Â  Â  const descInput = memberCard.querySelector('.new-goal-desc-input');
Â  Â  const text = textInput.value.trim();
Â  Â  const date = memberViewStates[memberId].date;
Â  Â  if (text && date) {
Â  Â  Â  const newGoal = { id: crypto.randomUUID(), subject: subjectInput.value.trim(), text, description: descInput.value.trim(), completed: false, totalTime: 0, isRunning: false, startTime: null };
Â  Â  Â  await updateDoc(memberDocRef, { [`dailyTasks.${date}`]: arrayUnion(newGoal) });
Â  Â  Â  subjectInput.value = ''; textInput.value = ''; descInput.value = '';
Â  Â  }
Â  Â  return;
Â  }
Â  if (e.target.matches('.carry-forward-btn')) {
Â  Â  Â  const dateStr = memberViewStates[memberId].date;
Â  Â  Â  const member = allMembersData.find(m => m.id === memberId);
Â  Â  Â  const incompleteTasks = (member.dailyTasks?.[dateStr] || []).filter(t => !t.completed);
Â  Â  Â  if (incompleteTasks.length === 0) { alert('No incomplete tasks to carry over!'); return; }
Â  Â  Â  const currentDate = new Date(`${dateStr}T12:00:00.000Z`);
Read-only
Â  Â  Â  currentDate.setUTCDate(currentDate.getUTCDate() + 1);
Â  Â  Â  const nextDateStr = currentDate.toISOString().split('T')[0];
Â  Â  Â  const tasksToCarry = incompleteTasks.map(t => ({...t, id: crypto.randomUUID(), completed: false, totalTime: 0, isRunning: false, startTime: null}));
Â  Â  Â  await updateDoc(memberDocRef, { [`dailyTasks.${nextDateStr}`]: arrayUnion(...tasksToCarry) });
Â  Â  Â  alert(`Carried over ${tasksToCarry.length} task(s) to ${nextDateStr}.`);
e Â  Â  return;
Â  }
Â  const goalItem = e.target.closest('.goal-item');
Â  if (!goalItem) return;
Â  const { goalId, goalDate } = goalItem.dataset;
Â  if (e.target.closest('.description-toggle-btn')) {
Â  Â  Â  const descEl = goalItem.querySelector('.task-description');
Â  Â  Â  if(descEl) descEl.classList.toggle('is-visible');
Â  Â  Â  return;
Â  }
Â  if (!goalId || !goalDate) return;
Â  if (e.target.closest('.timer-control-btn')) {
Â  Â  const action = e.target.closest('.timer-control-btn').dataset.action;
Â  Â  await handleTimerAction(memberDocRef, goalDate, goalId, action);
Â  Â  return;
Â  }
Â  try {
Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  const targetDoc = await transaction.get(memberDocRef);
Â  Â  Â  if (!targetDoc.exists()) throw "Document does not exist!";
Â  Â  Â  const tasks = targetDoc.data().dailyTasks || {};
Â  Â  Â  if (e.target.closest('.delete-goal-btn')) {
Â  Â  Â  Â  tasks[goalDate] = (tasks[goalDate] || []).filter(g => g.id !== goalId);
Â  Â  Â  Â  stopTimerDisplay(memberId, goalId);
Â  Â  Â  } else if (e.target.matches('.goal-checkbox')) {
Â  Â  Â  Â  tasks[goalDate] = (tasks[goalDate] || []).map(g => g.id === goalId ? { ...g, completed: e.target.checked } : g);
Â  Â  Â  }
Â  Â  Â  transaction.update(memberDocRef, { dailyTasks: tasks });
Â  Â  });
Â  } catch (error) { console.error("Goal update failed: ", error); }
}

async function updateAllMembersMonthlyTasks(monthStr, updateFn) {
Â  Â  if (allMembersData.length === 0) return;
Â  Â  const sourceTasks = allMembersData[0]?.monthlyTasks?.[monthStr] || [];
Â  Â  const updatedTasks = updateFn(sourceTasks);
Â  Â  const batch = writeBatch(db);
Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  const ref = doc(db, "members", member.id);
Â  Â  Â  Â  batch.update(ref, { [`monthlyTasks.${monthStr}`]: updatedTasks });
Â  Â  });
Â  Â  await batch.commit();
}

async function handleSharedMonthlyEvents(e) {
Â  const monthStr = getYearMonthString(calendarDate);

Â  if (e.target.matches('#add-monthly-goal-btn')) {
Â  Â  const subjectInput = document.getElementById('new-monthly-goal-subject');
Â  Â  const textInput = document.getElementById('new-monthly-goal-text');
Â  Â  const descInput = document.getElementById('new-monthly-goal-desc');
Â  Â  const text = textInput.value.trim();
Â  Â  if (!text || allMembersData.length === 0) return;
Â  Â  const newMonthlyTask = { id: crypto.randomUUID(), subject: subjectInput.value.trim(), text, description: descInput.value.trim(), completedBy: {} };
Â  Â  await updateAllMembersMonthlyTasks(monthStr, (tasks) => [...tasks, newMonthlyTask]);
Â  Â  subjectInput.value = ''; textInput.value = ''; descInput.value = '';
Â  Â  return;
Â  }

Â  const goalItem = e.target.closest('.goal-item');
Â  if (!goalItem) return;
Â  if (e.target.closest('.description-toggle-btn')) {
Â  Â  Â  const descEl = goalItem.querySelector('.task-description');
Â  Â  Â  if(descEl) descEl.classList.toggle('is-visible');
Â  Â  Â  return;
Â  }
Â Â 
Â  const taskId = goalItem.dataset.taskId;

Â  if (e.target.matches('.monthly-goal-checkbox')) {
Â  Â  Â  const targetMemberId = e.target.dataset.memberId;
Â  Â  Â  const isChecked = e.target.checked;
Â  Â  Â  await updateAllMembersMonthlyTasks(monthStr, (tasks) =>Â 
Â  Â  Â  Â  tasks.map(task => task.id === taskId ? { ...task, completedBy: { ...task.completedBy, [targetMemberId]: isChecked } } : task)
Â  Â  Â  );
Â  Â  Â  return;
Â  }
Â Â 
Â  // =============================================================
Â  // CORRECTED LOGIC FOR COPY-TO-DAILY-BTN STARTS HERE
Â  // =============================================================
Â  if (e.target.closest('.copy-to-daily-btn')) {
Â  Â  if (!currentMessengerId) {
Â  Â  Â  Â  alert("Please select your name from the 'I am:' dropdown in the messenger first.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const memberToUpdate = allMembersData.find(m => m.id === currentMessengerId);
Â  Â  if (!memberToUpdate) return;
Â  Â Â 
Â  Â  // Find the source task from the current user's own data, not just the first user. This is more robust.
Â  Â  const sourceTask = memberToUpdate.monthlyTasks?.[monthStr]?.find(t => t.id === taskId);
Â  Â  if (!sourceTask) {
Â  Â  Â  Â  console.error("Could not find the source monthly task to copy.");
Â  Â  Â  Â  alert("An error occurred. Could not find the task to copy.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const memberDocRef = doc(db, 'members', currentMessengerId);
Â  Â  const dateForDailyTask = memberViewStates[currentMessengerId]?.date || TODAY_STRING;

Â  Â  try {
Â  Â  Â  Â  // Use a transaction to safely read and then write to a single member's document.
Â  Â  Â  Â  // This makes adding the daily task AND updating their monthly task an atomic operation.
Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  const memberDoc = await transaction.get(memberDocRef);
Â  Â  Â  Â  Â  Â  if (!memberDoc.exists()) throw "Member document not found!";

Â  Â  Â  Â  Â  Â  const data = memberDoc.data();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Prepare the new daily goal
Â  Â  Â  Â  Â  Â  const newDailyGoal = {
Â  Â  Â  Â  Â  Â  Â  Â  id: crypto.randomUUID(),
Â  Â  Â  Â  Â  Â  Â  Â  subject: sourceTask.subject,
Â  Â  Â  Â  Â  Â  Â  Â  text: sourceTask.text,
Â  Â  Â  Â  Â  Â  Â  Â  description: sourceTask.description,
Â  Â  Â  Â  Â  Â  Â  Â  completed: false, totalTime: 0, isRunning: false, startTime: null
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const updatedDailyTasks = data.dailyTasks || {};
Note
Â  Â  Â  Â  Â  Â  const dailyTasksForDate = updatedDailyTasks[dateForDailyTask] || [];
Â  Â  Â  Â  Â  Â  dailyTasksForDate.push(newDailyGoal);
Â  Â  Â  Â  Â  Â  updatedDailyTasks[dateForDailyTask] = dailyTasksForDate;

Â  Â  Â  Â  Â  Â  // 2. Prepare the updated monthly tasks for this user
Â  Â  Â  Â  Â  Â  const updatedMonthlyTasks = { ...data.monthlyTasks };
Â  Â  Â  Â  Â  Â  const tasksForMonth = (updatedMonthlyTasks[monthStr] || []).map(task => {
Â  Â  Â  Â  Â  Â  Â  Â  if (task.id === taskId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedCompletedBy = { ...task.completedBy, [currentMessengerId]: true };
all Â  Â  Â  Â  Â  Â  Â  Â  return { ...task, completedBy: updatedCompletedBy };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return task;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  updatedMonthlyTasks[monthStr] = tasksForMonth;

Â  Â  Â  Â  Â  Â  // 3. Atomically update both fields for the current user.
Â  Â  t Â  Â  Â  transaction.update(memberDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  dailyTasks: updatedDailyTasks,
Â  Â  Â  Â  Â  Â  Â  Â  monthlyTasks: updatedMonthlyTasks
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // After the transaction is successful, sync the 'completed' status to all OTHER members.
Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  Â  Â  if (member.id !== currentMessengerId) { // Only update others
Â  Â  Â  Â  Â  Â  Â  Â  const otherMemberRef = doc(db, 'members', member.id);
Â  Â  Â  Â  Â  Â  Â  Â  const updatedTasksForOtherMember = (member.monthlyTasks?.[monthStr] || []).map(task => {
Note:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (task.id === taskId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedCompletedBy = { ...task.completedBy, [currentMessengerId]: true };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...task, completedBy: updatedCompletedBy };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return task;
Enter
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(otherMemberRef, { [`monthlyTasks.${monthStr}`]: updatedTasksForOtherMember });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  await batch.commit();

Â  Â  Â  Â  alert(`'${sourceTask.text}' added to your daily goals for ${dateForDailyTask} and marked as complete!`);

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error copying monthly task to daily:", error);
Â  Â  Â  Â  alert("Failed to copy the task. Please try again.");
Â  Â  }
Â  Â  return;
Â  }
Â  // =============================================================
Â  // CORRECTED LOGIC FOR COPY-TO-DAILY-BTN ENDS HERE
Â  // =============================================================

Â  if (e.target.closest('.delete-goal-btn')) {
Â  Â  Â  if (!confirm("Are you sure you want to delete this group goal for everyone?")) return;
Â  Â  Â  await updateAllMembersMonthlyTasks(monthStr, (tasks) => tasks.filter(t => t.id !== taskId));
Â  Â  Â  return;
Â  }
}

async function handleTimerAction(memberDocRef, date, goalId, action) {
Â  await runTransaction(db, async (transaction) => {
Â  Â  const memberDoc = await transaction.get(memberDocRef);
Â  Â  if (!memberDoc.exists()) return;
Â  Â  const data = memberDoc.data();
Â  Â  const tasks = data.dailyTasks || {};
Â  Â  let goalsForDate = tasks[date] || [];
Â  Â  const now = Date.now();
Â  Â Â 
Â  Â  // Stop any currently running timer for this member on this date
Â  Â  goalsForDate = goalsForDate.map(g => {
Â  Â  Â  Â  if (g.isRunning) {
Â  Â  Â  Â  Â  Â  return { ...g, isRunning: false, totalTime: getTotalTimeSpent(g), startTime: null };
content Â  Â  Â  }
Â  Â  Â  Â  return g;
Â  Â  });

Â  Â  // Start the new timer if the action is 'start'
Â  Â  if (action === 'start') {
Â  Â  Â  Â  goalsForDate = goalsForDate.map(g => g.id === goalId ? { ...g, isRunning: true, startTime: now } : g);
seconds Â  }
Â  Â Â 
Â  Â  tasks[date] = goalsForDate;
Â  Â  transaction.update(memberDocRef, { dailyTasks: tasks });
Â  });
}

// --- Timer Display Management ---
function startTimerDisplay(memberId, date, goalId) {
Â  Â  const intervalKey = `${memberId}-${goalId}`;
Â  Â  if (timerIntervals[intervalKey]) return;
Â  Â  timerIntervals[intervalKey] = setInterval(() => {
Â  Â  Â  Â  const member = allMembersData.find(m => m.id === memberId);
Note
Â  Â  Â  Â  if (!member) { stopTimerDisplay(memberId, goalId); return; }
Â  Â  Â  Â  const goal = member.dailyTasks?.[date]?.find(g => g.id === goalId);
Â  Â  Â  Â  if (!goal || !goal.isRunning) { stopTimerDisplay(memberId, goalId); return; }
Â  Â  Â  Â  const goalEl = document.querySelector(`[data-id="${memberId}"] [data-goal-id="${goalId}"]`);
Â  Â  Â  Â  if (goalEl) {
Â  Â  Â  Â  Â  Â  goalEl.querySelector('.timer-display').textContent = formatTime(getTotalTimeSpent(goal));
What Â  Â  Â  }
Â  Â  }, 1000);
}

function stopTimerDisplay(memberId, goalId) {
Â  Â  const intervalKey = `${memberId}-${goalId}`;
Â  Â  if (timerIntervals[intervalKey]) {
Â  Â  Â  Â  clearInterval(timerIntervals[intervalKey]);
Â  Â  Â  Â  delete timerIntervals[intervalKey];
Â  Â  }
}

// --- Initializer ---
function setupEventHandlers() {
Â  document.getElementById('add-member-btn').addEventListener('click', async () => {
Â  Â  const input = document.getElementById('new-member-name-input');
Â  Â  const name = input.value.trim();
Â  Â  if (!name) return;
CSS Â  Â  await addDoc(collection(db, 'members'), {
Â  Â  Â  name, dailyTasks: {}, monthlyTasks: {}, createdAt: serverTimestamp()
Â  Â  });
Â  Â  input.value = '';
Â  });

Â  document.getElementById('master-calendar-container').addEventListener('click', (e) => {
Â  Â  let needsFullRender = false;
Â  Â  if (e.target.closest('#prev-month-btn')) {
Â  Â  Â  Â  calendarDate.setMonth(calendarDate.getMonth() - 1);
Â  Â  Â  Â  needsFullRender = true;
Â  Â  } else if (e.target.closest('#next-month-btn')) {
Â  Â  Â  Â  calendarDate.setMonth(calendarDate.getMonth() + 1);
A Â  Â  Â  needsFullRender = true;
Â  Â  } else if (e.target.closest('.calendar-day')) {
Â  Â  Â  const newDate = e.target.closest('.calendar-day').dataset.date;
Â  Â  Â  allMembersData.forEach(member => {
Â  Â  Â  Â  Â  if (!memberViewStates[member.id]) memberViewStates[member.id] = {};
Â  Â  Â  Â  Â  memberViewStates[member.id].date = newDate;
Â  Note
Â  Â  Â  });
Â  Â  Â  updateMembersUI(allMembersData);
Â  Â  }
Â  Â  if (needsFullRender) renderApp();
Â  });

Â  document.getElementById('members-container').addEventListener('click', handleMemberEvents);
Â  document.getElementById('members-container').addEventListener('change', handleMemberEvents);
Â  document.getElementById('monthly-goals-container').addEventListener('click', handleSharedMonthlyEvents);
Â  document.getElementById('monthly-goals-container').addEventListener('change', handleSharedMonthlyEvents);
Â  document.getElementById('messenger-user-select').addEventListener('change', (e) => {
Â  Â  Â  currentMessengerId = e.target.value;
Â  Â  Â  localStorage.setItem('currentMessengerId', currentMessengerId);
Example
Â  Â  Â  renderSharedMonthlyView();
Â  Â  Â  identifyUserInOneSignal(currentMessengerId);
Â  });

Â  const sendMessage = async () => {
Â  Â  const input = document.getElementById('message-input');
Â  Â  const text = input.value.trim();
Â  Â  if (!currentMessengerId) { alert("Please select your name from the 'I am:' dropdown to send a message."); return; }
Â  Â  if (!text) return;
Â  Â  const sender = allMembersData.find(m => m.id === currentMessengerId);
Â  Â  if (!sender) return;
Â  Â  await addDoc(collection(db, 'messages'), { text, senderId: currentMessengerId, senderName: sender.name, createdAt: serverTimestamp() });
Â  Â  input.value = '';
Â  };
Â  document.getElementById('send-message-btn').addEventListener('click', sendMessage);
Â  document.getElementById('message-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
}

function setupFirestoreListeners() {
January Â  onSnapshot(query(collection(db, 'members'), orderBy('name', 'asc')), (snapshot) => {
Â  Â  allMembersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  seedInitialMonthlyTasks();
Â  Â  renderApp();
Â  Â  if (currentMessengerId) identifyUserInOneSignal(currentMessengerId);
Â  });
Â  onSnapshot(query(collection(db, 'messages'), orderBy('createdAt', 'asc')), (snapshot) => renderMessages(snapshot.docs));
}

function main() {
Â  setupEventHandlers();
Â  onAuthStateChanged(auth, (user) => {
Â  Â  if (user) {
Â  Â  Â  document.getElementById('loader').textContent = "Loading members...";Â 
Â  Â  Â  setupFirestoreListeners();
Â  Â  } else {
Example
Â  Â  Â  signInAnonymously(auth).catch((error) => {
Â  Â  Â  Â  console.error("Anonymous sign-in failed:", error);
Â  Â  Â  Â  document.getElementById('loader').textContent = "Connection failed. Please refresh.";
Â  Â  Â  });
Â  Â  }
Â  });
}

main();
</script>

</body>
</html>
