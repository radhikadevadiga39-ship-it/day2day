<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Day2Day âœ¨ â€“ Girly Diary Task App</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Pacifico&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#fff1f6; /* soft pink */
      --bg2:#ffe8f1; /* blush */
      --ink:#3b1d2c; /* plum-brown */
      --pri:#ff6fb7; /* hot pink */
      --pri-2:#ffa6d3; /* light hot pink */
      --sec:#8b5cf6; /* lavender */
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    html,body{height:100%;}
    body{
      background: radial-gradient(1000px 600px at -10% -10%, var(--bg2), transparent),
                  radial-gradient(800px 500px at 110% -10%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), #ffffff);
      color:var(--ink);
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    /* cute floating bubbles */
    .bubble{
      position:absolute; border-radius:9999px; filter:blur(12px); opacity:.5; pointer-events:none;
      animation: float 18s ease-in-out infinite;
    }
    @keyframes float { 0%{ transform:translateY(0) translateX(0) scale(1);} 50%{ transform:translateY(-20px) translateX(10px) scale(1.05);} 100%{ transform:translateY(0) translateX(0) scale(1);} }

    .card{ backdrop-filter: blur(10px); }
    .tick-anim{ transition: transform .2s ease, opacity .2s ease; }
    .tick-anim.checked{ transform: scale(1.05); opacity:.85; }
    .shine{
      position:relative; overflow:hidden;
    }
    .shine::after{
      content:""; position:absolute; inset:-200% -200% auto auto; width:60%; height:200%;
      transform: rotate(25deg); background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
      animation: shine 5s linear infinite;
    }
    @keyframes shine{ 0%{ transform: translateX(-120%) rotate(25deg);} 60%{ transform: translateX(40%) rotate(25deg);} 100%{ transform: translateX(120%) rotate(25deg);} }

    /* minimal calendar styles */
    .calendar-grid{ display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:.5rem; }
    .day-cell{ min-height:72px; }
  </style>
</head>
<body class="relative min-h-full">
  <!-- background bubbles -->
  <div class="bubble" style="top:8%; left:5%; width:160px; height:160px; background:radial-gradient(circle, #ffd3e8, transparent);"></div>
  <div class="bubble" style="top:60%; left:80%; width:240px; height:240px; background:radial-gradient(circle, #e9d5ff, transparent);"></div>
  <div class="bubble" style="top:30%; left:60%; width:180px; height:180px; background:radial-gradient(circle, #ffc7e3, transparent);"></div>

  <!-- Header / Auth -->
  <header class="max-w-6xl mx-auto px-4 pt-6 pb-2">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-white/70 ring-2 ring-pink-300 flex items-center justify-center text-2xl">âœ¨</div>
        <div>
          <h1 class="font-black text-3xl sm:text-4xl tracking-tight" style="font-family:Pacifico, cursive; color:var(--pri)">Day2Day</h1>
          <div class="text-sm -mt-1 text-pink-700/80">girly diary â€¢ tasks â€¢ vibes ğŸ’–</div>
        </div>
      </div>
      <div id="authArea" class="flex items-center gap-3">
        <!-- Populated by JS (Sign in / User chip) -->
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pb-24">
    <!-- Onboarding / create or join space -->
    <section id="onboard" class="hidden">
      <div class="card rounded-3xl p-6 bg-white/70 shadow-xl ring-1 ring-white/50">
        <div class="flex flex-col md:flex-row gap-6 items-start">
          <div class="flex-1">
            <h2 class="text-2xl font-extrabold text-pink-700">Hey gorgeous! ğŸŒ¸</h2>
            <p class="text-sm text-pink-900/80 mt-1">Welcome to your shared diary task app. Pick a cute emoji avatar and a space name to collaborate with your besties. Google Signâ€‘In only (Gmail), so youâ€™re safe & synced.</p>
            <div class="mt-4 grid sm:grid-cols-2 gap-4">
              <label class="block text-sm">
                <span class="font-semibold">Your display name</span>
                <input id="displayNameInput" type="text" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="Tejal, Boss Babe, etc."/>
              </label>
              <label class="block text-sm">
                <span class="font-semibold">Pick an emoji avatar</span>
                <input id="emojiInput" type="text" maxlength="2" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="ğŸ’– ğŸ¦‹ ğŸŒ¸ ğŸ˜»"/>
              </label>
              <label class="block text-sm sm:col-span-2">
                <span class="font-semibold">Shared space name</span>
                <input id="spaceInput" type="text" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="room name everyone uses (e.g., besties, study-club)"/>
              </label>
            </div>
            <button id="saveProfileBtn" class="mt-4 px-5 py-3 rounded-2xl bg-pink-500 text-white font-semibold hover:bg-pink-600 active:scale-95 transition shine">Save & Start ğŸ’…</button>
          </div>
          <div class="flex-1 w-full">
            <div class="rounded-3xl bg-gradient-to-br from-pink-200 to-pink-100 p-4 ring-1 ring-pink-300/40">
              <h3 class="font-bold text-pink-800">What you get</h3>
              <ul class="list-disc pl-6 mt-2 text-sm text-pink-900/80 space-y-1">
                <li>Shared tasks per space (add your squad once & go ğŸ’«)</li>
                <li>Tick off tasks with satisfying animations âœ…</li>
                <li>Calendar view with due dates ğŸ“…</li>
                <li>Task descriptions + optional feedback ğŸ’¬</li>
                <li>Member profiles with emoji avatars ğŸ«¶</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="app" class="hidden">
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Left: Create Task -->
        <div class="lg:col-span-1">
          <div class="card rounded-3xl p-6 bg-white/70 shadow-xl ring-1 ring-white/50">
            <h2 class="text-xl font-extrabold text-pink-700">New task âœï¸</h2>
            <div class="mt-3 grid grid-cols-1 gap-3">
              <label class="text-sm font-semibold">Title
                <input id="taskTitle" type="text" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="e.g. Submit assignment"/>
              </label>
              <label class="text-sm font-semibold">Description
                <textarea id="taskDesc" rows="3" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="Add the juicy details ğŸ’—"></textarea>
              </label>
              <div class="grid grid-cols-2 gap-3">
                <label class="text-sm font-semibold">Due date
                  <input id="taskDue" type="date" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300"/>
                </label>
                <label class="text-sm font-semibold">Assignee
                  <select id="taskAssignee" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300"></select>
                </label>
              </div>
              <label class="text-sm font-semibold">Optional feedback note (private to assignee)
                <input id="taskFeedback" type="text" class="mt-1 w-full rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="You got this! â­"/>
              </label>
              <button id="addTaskBtn" class="mt-2 px-5 py-3 rounded-2xl bg-pink-500 text-white font-semibold hover:bg-pink-600 active:scale-95 transition shine">Add task ğŸ’–</button>
            </div>
          </div>

          <div class="card rounded-3xl p-6 bg-white/70 shadow-xl ring-1 ring-white/50 mt-6">
            <h3 class="text-lg font-extrabold text-pink-700">Members ğŸ«¶</h3>
            <div id="memberList" class="mt-3 grid gap-2"></div>
          </div>
        </div>

        <!-- Right: Tasks + Calendar -->
        <div class="lg:col-span-2 space-y-6">
          <div class="card rounded-3xl p-6 bg-white/70 shadow-xl ring-1 ring-white/50">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <h2 class="text-xl font-extrabold text-pink-700">Tasks for <span id="spaceLabel" class="underline decoration-wavy decoration-pink-400"></span></h2>
              <div class="flex gap-2">
                <input id="searchInput" type="text" class="w-full sm:w-64 rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300" placeholder="Search title/desc"/>
                <select id="filterSelect" class="rounded-xl border-pink-200 focus:border-pink-400 focus:ring-pink-300">
                  <option value="all">All</option>
                  <option value="open">Open</option>
                  <option value="done">Done</option>
                  <option value="mine">Assigned to me</option>
                </select>
              </div>
            </div>
            <div id="taskList" class="mt-4 grid gap-3"></div>
          </div>

          <div class="card rounded-3xl p-6 bg-white/70 shadow-xl ring-1 ring-white/50">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-extrabold text-pink-700">Calendar ğŸ“…</h2>
              <div class="flex items-center gap-2">
                <button id="prevMonth" class="px-3 py-2 rounded-xl bg-white/90 ring-1 ring-pink-200 hover:bg-pink-50">â—€</button>
                <div id="monthLabel" class="font-bold"></div>
                <button id="nextMonth" class="px-3 py-2 rounded-xl bg-white/90 ring-1 ring-pink-200 hover:bg-pink-50">â–¶</button>
              </div>
            </div>
            <div class="calendar-grid mt-4">
              <div class="text-xs font-semibold text-center text-pink-800">Sun</div>
              <div class="text-xs font-semibold text-center text-pink-800">Mon</div>
              <div class="text-xs font-semibold text-center text-pink-800">Tue</div>
              <div class="text-xs font-semibold text-center text-pink-800">Wed</div>
              <div class="text-xs font-semibold text-center text-pink-800">Thu</div>
              <div class="text-xs font-semibold text-center text-pink-800">Fri</div>
              <div class="text-xs font-semibold text-center text-pink-800">Sat</div>
            </div>
            <div id="calendarDays" class="calendar-grid mt-2"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer brand -->
  <footer class="fixed bottom-4 right-4 text-xs text-pink-700/70 select-none">textday2day â€¢ made with ğŸ’—</footer>

  <!-- Firebase SDKs (Compat for simplicity in one HTML file) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

  <script>
    // === Firebase config (from your sample) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCERpjMWaks-VwF0rQl4fTUJA6alU8QnzU",
      authDomain: "day2day-43309.firebaseapp.com",
      projectId: "day2day-43309",
      storageBucket: "day2day-43309.firebasestorage.app",
      messagingSenderId: "796454338022",
      appId: "1:796454338022:web:44db8be83228bb12606a27",
      measurementId: "G-FVWXBE61MD"
    };

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    try { firebase.analytics(); } catch(e) {}

    // DOM refs
    const authArea = document.getElementById('authArea');
    const onboard = document.getElementById('onboard');
    const appEl = document.getElementById('app');

    const displayNameInput = document.getElementById('displayNameInput');
    const emojiInput = document.getElementById('emojiInput');
    const spaceInput = document.getElementById('spaceInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    const taskTitle = document.getElementById('taskTitle');
    const taskDesc = document.getElementById('taskDesc');
    const taskDue = document.getElementById('taskDue');
    const taskAssignee = document.getElementById('taskAssignee');
    const taskFeedback = document.getElementById('taskFeedback');
    const addTaskBtn = document.getElementById('addTaskBtn');

    const taskList = document.getElementById('taskList');
    const memberList = document.getElementById('memberList');
    const spaceLabel = document.getElementById('spaceLabel');

    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');

    // Calendar refs
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const monthLabel = document.getElementById('monthLabel');
    const calendarDays = document.getElementById('calendarDays');

    // State
    let currentUser = null;
    let currentSpace = null; // string
    let unsubscribeTasks = null;
    let unsubscribeMembers = null;
    let calendarCursor = new Date();

    // Helpers
    const byId = (id) => document.getElementById(id);
    const fmtDate = (d) => {
      if (!d) return '';
      const dt = (d instanceof Date) ? d : new Date(d);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    function userChip(user){
      const span = document.createElement('div');
      span.className = 'flex items-center gap-3 bg-white/70 ring-1 ring-pink-200 px-3 py-2 rounded-2xl shadow-sm';
      const emoji = (user?.emoji) || 'ğŸ’–';
      span.innerHTML = `
        <div class="text-2xl">${emoji}</div>
        <div class="leading-tight">
          <div class="font-semibold">${user?.displayName || user?.email || 'Me'}</div>
          <div class="text-[11px] text-pink-700/70">${user?.email || ''}</div>
        </div>
        <button id="signOutBtn" class="ml-2 px-3 py-1 rounded-xl bg-white/90 ring-1 ring-pink-200 hover:bg-pink-50 text-xs">Sign out</button>
      `;
      return span;
    }

    function signInButton(){
      const btn = document.createElement('button');
      btn.className = 'px-4 py-2 rounded-2xl bg-pink-500 text-white font-semibold hover:bg-pink-600 active:scale-95 transition';
      btn.textContent = 'Sign in with Google';
      btn.onclick = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        // Force Google; Gmail accounts will work. (No other providers enabled.)
        await auth.signInWithPopup(provider);
      };
      return btn;
    }

    // Render auth area
    function renderAuth(userDoc){
      authArea.innerHTML = '';
      if (!currentUser){
        authArea.appendChild(signInButton());
        return;
      }
      authArea.appendChild(userChip(userDoc));
      authArea.querySelector('#signOutBtn').onclick = async ()=>{
        await auth.signOut();
      };
    }

    // Ensure member exists (no need to re-add every time)
    async function ensureMember(user){
      const membersRef = db.collection('spaces').doc(currentSpace).collection('members').doc(user.uid);
      const snap = await membersRef.get();
      if (!snap.exists){
        const profile = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || displayNameInput.value || user.email,
          emoji: emojiInput.value || 'ğŸ’–',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        await membersRef.set(profile, { merge:true });
      } else if (emojiInput.value || displayNameInput.value){
        await membersRef.set({
          displayName: displayNameInput.value || snap.data().displayName,
          emoji: emojiInput.value || snap.data().emoji
        }, { merge:true });
      }
    }

    // Load members live
    function watchMembers(){
      if (unsubscribeMembers) unsubscribeMembers();
      const membersRef = db.collection('spaces').doc(currentSpace).collection('members');
      unsubscribeMembers = membersRef.orderBy('displayName').onSnapshot(snap=>{
        memberList.innerHTML = '';
        taskAssignee.innerHTML = '';
        snap.forEach(doc=>{
          const m = doc.data();
          const row = document.createElement('div');
          row.className = 'flex items-center gap-3 bg-white/80 px-3 py-2 rounded-2xl ring-1 ring-pink-200';
          row.innerHTML = `
            <div class="text-2xl">${m.emoji || 'ğŸ’–'}</div>
            <div class="flex-1">
              <div class="font-semibold">${m.displayName || m.email}</div>
              <div class="text-[11px] text-pink-700/70">${m.email || ''}</div>
            </div>
          `;
          memberList.appendChild(row);

          const opt = document.createElement('option');
          opt.value = m.uid;
          opt.textContent = `${m.emoji || 'ğŸ’–'} ${m.displayName || m.email}`;
          taskAssignee.appendChild(opt);
        });
      });
    }

    // Create task
    async function addTask(){
      const title = taskTitle.value.trim();
      if (!title) return alert('Add a cute title âœ¨');
      const desc = taskDesc.value.trim();
      const due = taskDue.value || null;
      const assignee = taskAssignee.value || currentUser.uid;
      const feedback = taskFeedback.value.trim() || '';
      await db.collection('spaces').doc(currentSpace).collection('tasks').add({
        title, desc, due, assignee,
        feedback, done:false,
        createdBy: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      // clear
      taskTitle.value = ''; taskDesc.value=''; taskDue.value=''; taskFeedback.value='';
    }

    // Render tasks
    function watchTasks(){
      if (unsubscribeTasks) unsubscribeTasks();
      const q = db.collection('spaces').doc(currentSpace).collection('tasks').orderBy('createdAt','desc');
      unsubscribeTasks = q.onSnapshot(snap=>{
        const tasks = [];
        snap.forEach(d=>tasks.push({id:d.id, ...d.data()}));
        renderTaskList(tasks);
        renderCalendar(tasks);
      });
    }

    function renderTaskList(tasks){
      const term = (searchInput.value||'').toLowerCase();
      const mode = filterSelect.value || 'all';
      const filtered = tasks.filter(t=>{
        const matchTerm = !term || (t.title?.toLowerCase().includes(term) || t.desc?.toLowerCase().includes(term));
        const matchMode = (
          mode==='all' ||
          (mode==='open' && !t.done) ||
          (mode==='done' && !!t.done) ||
          (mode==='mine' && t.assignee===currentUser?.uid)
        );
        return matchTerm && matchMode;
      });

      taskList.innerHTML = '';
      if (!filtered.length){
        const empty = document.createElement('div');
        empty.className = 'text-center text-pink-800/70';
        empty.textContent = 'No tasks yet. Add something gorgeous âœ¨';
        taskList.appendChild(empty);
        return;
      }

      filtered.forEach(t=>{
        const item = document.createElement('div');
        item.className = 'rounded-2xl bg-white/80 ring-1 ring-pink-200 p-3 flex items-start gap-3 hover:ring-pink-300 transition';
        const checked = !!t.done;
        item.innerHTML = `
          <button aria-label="tick" data-id="${t.id}" class="tick-anim mt-1 w-6 h-6 flex items-center justify-center rounded-lg ring-1 ${checked? 'bg-green-100 ring-green-300' : 'bg-white ring-pink-200'}">${checked? 'âœ…' : 'â¬œ'}</button>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <div class="font-semibold ${checked? 'line-through text-pink-800/50' : ''}">${t.title}</div>
              ${t.due ? `<span class='text-[11px] px-2 py-0.5 rounded-full ${checked? 'bg-green-100 text-green-700 ring-1 ring-green-200' : 'bg-pink-100 text-pink-700 ring-1 ring-pink-200'}'>${t.due}</span>` : ''}
            </div>
            ${t.desc ? `<div class="text-sm text-pink-900/80 ${checked? 'line-through opacity-70' : ''}">${t.desc}</div>` : ''}
            ${t.feedback ? `<div class="text-xs mt-1 px-2 py-1 rounded-xl bg-white/90 ring-1 ring-pink-200">ğŸ’¬ ${t.feedback}</div>` : ''}
            <div class="text-[11px] text-pink-700/70 mt-1">Assigned to: <span data-assignee="${t.assignee}">...</span></div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <button data-del="${t.id}" class="text-xs px-2 py-1 rounded-xl bg-white/90 ring-1 ring-pink-200 hover:bg-pink-50">Delete</button>
          </div>
        `;
        taskList.appendChild(item);
      });

      // Fill assignee names
      db.collection('spaces').doc(currentSpace).collection('members').get().then(snap=>{
        const map = {};
        snap.forEach(d=> map[d.id] = d.data());
        taskList.querySelectorAll('[data-assignee]').forEach(el=>{
          const uid = el.getAttribute('data-assignee');
          const m = map[uid];
          el.textContent = m ? `${m.emoji || 'ğŸ’–'} ${m.displayName || m.email}` : 'Unknown';
        });
      });

      // Hook actions
      taskList.querySelectorAll('[data-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          const ref = db.collection('spaces').doc(currentSpace).collection('tasks').doc(id);
          const snap = await ref.get();
          const done = !snap.data().done;
          await ref.update({ done });
          btn.classList.toggle('checked', done);
        });
      });
      taskList.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-del');
          if (confirm('Delete this task?')){
            await db.collection('spaces').doc(currentSpace).collection('tasks').doc(id).delete();
          }
        });
      });
    }

    // Calendar rendering
    function renderCalendar(tasks){
      const year = calendarCursor.getFullYear();
      const month = calendarCursor.getMonth();
      const firstDay = new Date(year, month, 1);
      const startIdx = firstDay.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthLabel.textContent = `${monthNames[month]} ${year}`;
      calendarDays.innerHTML = '';

      // Build a map of date -> tasks
      const map = {};
      (tasks||[]).forEach(t=>{ if (t.due){ (map[t.due] ||= []).push(t); }});

      // Leading blanks
      for (let i=0;i<startIdx;i++){
        const blank = document.createElement('div');
        blank.className = 'day-cell';
        calendarDays.appendChild(blank);
      }
      // Actual days
      for (let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div');
        cell.className = 'day-cell rounded-xl bg-white/80 ring-1 ring-pink-200 p-2 flex flex-col';
        const dateStr = fmtDate(new Date(year, month, d));
        const list = map[dateStr] || [];
        cell.innerHTML = `
          <div class="text-xs font-bold text-pink-800">${d}</div>
          <div class="mt-1 space-y-1 max-h-24 overflow-auto">
            ${list.map(t=>`<div class='text-[11px] px-1.5 py-0.5 rounded-lg ${t.done? 'bg-green-100 ring-1 ring-green-200' : 'bg-pink-100 ring-1 ring-pink-200'} truncate'>${t.title}</div>`).join('')}
          </div>
        `;
        calendarDays.appendChild(cell);
      }
    }

    prevMonthBtn.addEventListener('click', ()=>{ calendarCursor.setMonth(calendarCursor.getMonth()-1); if (currentSpace) watchTasks(); });
    nextMonthBtn.addEventListener('click', ()=>{ calendarCursor.setMonth(calendarCursor.getMonth()+1); if (currentSpace) watchTasks(); });

    addTaskBtn.addEventListener('click', addTask);
    searchInput.addEventListener('input', ()=>{ if (currentSpace) watchTasks(); });
    filterSelect.addEventListener('change', ()=>{ if (currentSpace) watchTasks(); });

    saveProfileBtn.addEventListener('click', async ()=>{
      const nm = (displayNameInput.value || '').trim();
      const sp = (spaceInput.value || '').trim().toLowerCase();
      currentSpace = sp || 'day2day'; // default global space name if empty
      await ensureMember(currentUser);
      spaceLabel.textContent = currentSpace;
      watchMembers();
      watchTasks();
      hide(onboard); show(appEl);
    });

    // Auth listener
    auth.onAuthStateChanged(async (user)=>{
      currentUser = user;
      if (!user){
        hide(onboard); hide(appEl);
        authArea.innerHTML = '';
        authArea.appendChild(signInButton());
        return;
      }
      // Load / create user profile doc in a personal meta collection
      const userDocRef = db.collection('users').doc(user.uid);
      const userSnap = await userDocRef.get();
      if (!userSnap.exists){
        await userDocRef.set({
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || '',
          emoji: 'ğŸ’–',
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await userDocRef.set({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      }

      const userDoc = (await userDocRef.get()).data();
      renderAuth(userDoc);

      // On first login, show onboarding if no space selected yet
      currentSpace = localStorage.getItem('space') || null;
      if (!currentSpace){
        show(onboard); hide(appEl);
      } else {
        spaceLabel.textContent = currentSpace;
        show(appEl); hide(onboard);
        watchMembers();
        watchTasks();
      }
    });

    // Persist chosen space locally so you don't have to re-add members every time
    saveProfileBtn.addEventListener('click', ()=>{
      if (currentSpace) localStorage.setItem('space', currentSpace);
    });
  </script>
</body>
</html>
