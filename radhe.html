<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Day2Day ‚ú® ‚Äî Diary Tasks</title>
  <style>
    :root{
      --pink:#ff7eb8;
      --rose:#ffb3cd;
      --blush:#ffd6e6;
      --lav:#a97cff;
      --mint:#b6ffe0;
      --ink:#2a2233;
      --bg:#fff7fb;
      --card:#ffffff;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";}
    /* Cute header */
    header{
      position:sticky;top:0;z-index:5;
      background: linear-gradient(90deg,var(--blush),var(--rose),var(--lav));
      color:#331a3a;border-bottom:2px dashed rgba(0,0,0,0.08);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 18px;backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:0.5px;font-size:20px;
      text-transform: lowercase;
    }
    .brand .sparkle{animation: twinkle 1.8s ease-in-out infinite;}
    @keyframes twinkle {0%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(1.06)} 100%{opacity:1;transform:scale(1)}}
    .pill{
      background:#fff;color:var(--ink);border-radius:999px;padding:8px 12px;
      box-shadow:0 6px 16px rgba(255,126,184,0.25);display:flex;align-items:center;gap:8px;
    }
    .btn{
      border:0;border-radius:12px;padding:10px 14px;cursor:pointer;
      background:linear-gradient(135deg,var(--rose),var(--pink));color:#3b1130;font-weight:700;
      box-shadow:0 8px 16px rgba(255,126,184,0.35);transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{transform: translateY(-2px);filter: brightness(1.05);box-shadow:0 10px 20px rgba(255,126,184,0.45)}
    .btn.ghost{background:#fff;color:var(--ink);border:2px dashed var(--rose);box-shadow:none}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns: 300px 1fr;gap:18px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{
      background:var(--card);border-radius:18px;border:1px solid #f3e3ef;
      box-shadow:0 8px 28px rgba(169,124,255,0.12), 0 2px 6px rgba(0,0,0,0.03);
      padding:14px 14px 10px 14px;overflow:hidden
    }
    .section-title{font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#7a5a88;margin:4px 0 10px}
    /* Sidebar */
    .profile{
      display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;background:linear-gradient(180deg,#fff, #fff8ff)
    }
    .avatar{font-size:28px;filter: drop-shadow(0 6px 8px rgba(0,0,0,0.08))}
    .label{font-size:12px;color:#846394}
    .space-row{display:flex;gap:8px;margin-top:10px}
    input[type="text"], textarea, select, input[type="date"]{
      width:100%;padding:10px 12px;border:1px dashed #efc7dc;border-radius:12px;background:#fff;outline:none;
      font:inherit;color:var(--ink);transition:border-color .2s ease, box-shadow .2s ease
    }
    input:focus, textarea:focus, select:focus{border-color:var(--pink);box-shadow:0 0 0 4px rgba(255,126,184,0.15)}
    .calendar-row{display:flex;gap:8px;align-items:center}
    /* Members */
    .members{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px dashed #f1cfe0;background:#fff
    }
    .chip .kick{background:transparent;border:0;color:#c04a7f;font-weight:800;cursor:pointer}
    /* Tasks */
    .taskbar{display:flex;gap:10px;flex-wrap:wrap}
    .task{
      display:grid;grid-template-columns: 28px 1fr auto;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;border:1px solid #f0e0f0;background:linear-gradient(180deg,#fff,#fff9fd);
      transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
    }
    .task:hover{transform: translateY(-1px);box-shadow:0 8px 22px rgba(255,179,205,0.18)}
    .task.done{opacity:0.72;filter:saturate(0.7)}
    .task-title{font-weight:800}
    .task-desc{font-size:13px;color:#6b5b75}
    .assignees{display:flex;gap:6px}
    .emoji{font-size:18px}
    .tag{padding:4px 8px;border-radius:999px;background:var(--mint);font-size:12px}
    .feedback{display:flex;gap:8px;margin-top:6px}
    .empty{padding:16px;text-align:center;color:#846394}
    /* Subtle float animation */
    .float{animation: floaty 6s ease-in-out infinite}
    @keyframes floaty {0%{transform: translateY(0)} 50%{transform: translateY(-6px)} 100%{transform: translateY(0)}}
  </style>
</head>
<body>
  <header>
    <div class="brand float">
      <span class="sparkle">‚ú®</span>
      <span style="font-size:22px;">Day2Day</span>
      <span style="font-weight:300">‚Äî diary task app</span>
    </div>
    <div class="pill">
      <span id="userAvatar" class="avatar">üôÇ</span>
      <span id="userName">Guest</span>
      <button id="signInBtn" class="btn">Sign in with Google</button>
      <button id="signOutBtn" class="btn ghost" style="display:none">Sign out</button>
    </div>
  </header>

  <main>
    <!-- LEFT: Profile & Filters -->
    <section class="card">
      <div class="section-title">Profile</div>
      <div class="profile">
        <div id="profileEmoji" class="avatar">üíñ</div>
        <div>
          <div id="profileName" style="font-weight:800">Not signed in</div>
          <div id="profileEmail" class="label">‚Äî</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="label">Pick emoji avatar</div>
      <select id="emojiSelect">
        <option>üíñ</option><option>üå∏</option><option>üéÄ</option><option>ü¶©</option>
        <option>üßÅ</option><option>ü´∂</option><option>üåà</option><option>ü¶Ñ</option>
        <option>üòä</option><option>‚ú®</option><option>üçì</option><option>üåº</option>
      </select>
      <div style="height:6px"></div>
      <button class="btn" id="saveAvatarBtn">Save avatar</button>

      <div style="height:16px"></div>
      <div class="section-title">Space</div>
      <div class="label">Shared space code (invite friends)</div>
      <div class="space-row">
        <input type="text" id="spaceCode" placeholder="e.g., study-buds" />
        <button class="btn" id="joinSpaceBtn">Join</button>
      </div>
      <div class="label" style="margin-top:8px">Members</div>
      <div id="memberList" class="members"></div>

      <div style="height:16px"></div>
      <div class="section-title">Calendar</div>
      <div class="calendar-row">
        <input type="date" id="taskDate" />
        <button class="btn" id="todayBtn">Today</button>
      </div>
    </section>

    <!-- RIGHT: Tasks -->
    <section class="card">
      <div class="section-title">New task</div>
      <div class="taskbar">
        <input type="text" id="taskTitle" placeholder="Title (e.g., Revise glycolysis)" />
        <input type="text" id="taskFor" placeholder="Assign to (email, optional)" />
        <textarea id="taskDesc" placeholder="Description (optional)"></textarea>
        <button class="btn" id="addTaskBtn">Add task</button>
      </div>

      <div style="height:10px"></div>
      <div class="section-title">Tasks</div>
      <div id="taskList"></div>
      <div id="emptyState" class="empty" style="display:none">No tasks for this date. Add something cute ‚ú®</div>
    </section>
  </main>

  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase Web v10+ modular SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Replace with the provided sample configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCERpjMWaks-VwF0rQl4fTUJA6alU8QnzU",
      authDomain: "day2day-43309.firebaseapp.com",
      projectId: "day2day-43309",
      storageBucket: "day2day-43309.firebasestorage.app",
      messagingSenderId: "796454338022",
      appId: "1:796454338022:web:44db8be83228bb12606a27",
      measurementId: "G-FVWXBE61MD"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const profileEmoji = document.getElementById('profileEmoji');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const emojiSelect = document.getElementById('emojiSelect');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const spaceCodeInput = document.getElementById('spaceCode');
    const joinSpaceBtn = document.getElementById('joinSpaceBtn');
    const memberList = document.getElementById('memberList');
    const taskDate = document.getElementById('taskDate');
    const todayBtn = document.getElementById('todayBtn');
    const taskTitle = document.getElementById('taskTitle');
    const taskFor = document.getElementById('taskFor');
    const taskDesc = document.getElementById('taskDesc');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');

    // State
    let currentUser = null;
    let currentSpace = null;
    let taskUnsub = null;
    let memberUnsub = null;

    // Helpers
    function todayStr(d=new Date()){
      const tzOff = d.getTimezoneOffset() * 60000;
      const local = new Date(d - tzOff);
      return local.toISOString().slice(0,10);
    }
    function renderMembers(members){
      memberList.innerHTML = '';
      if (!members.length){ memberList.innerHTML = '<span class="label">No members yet</span>'; return; }
      members.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `<span class="emoji">${m.avatar || 'üå∏'}</span><span>${m.displayName || m.email}</span>`;
        memberList.appendChild(div);
      });
    }
    function renderTasks(tasks){
      taskList.innerHTML = '';
      if (!tasks.length){ emptyState.style.display='block'; return; }
      emptyState.style.display='none';
      tasks.forEach(t=>{
        const div = document.createElement('div');
        div.className = 'task' + (t.done ? ' done' : '');
        div.innerHTML = `
          <input type="checkbox" ${t.done?'checked':''} data-id="${t.id}" />
          <div>
            <div class="task-title">${t.title}</div>
            <div class="task-desc">${t.description || ''}</div>
            <div class="assignees">${(t.assignees||[]).map(a=>`<span class="emoji" title="${a}">üë§</span>`).join('')}</div>
            <div class="feedback">
              <input type="text" placeholder="Feedback (optional)" value="${t.feedback||''}" data-fb="${t.id}" />
              <span class="tag">${t.date}</span>
            </div>
          </div>
          <div>
            <button class="btn ghost" data-del="${t.id}">üóëÔ∏è</button>
          </div>
        `;
        taskList.appendChild(div);
      });
    }

    // Auth
    signInBtn.onclick = async ()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };
    signOutBtn.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      if (!user){
        userName.textContent = 'Guest';
        userAvatar.textContent = 'üôÇ';
        profileName.textContent = 'Not signed in';
        profileEmail.textContent = '‚Äî';
        signInBtn.style.display = 'inline-flex';
        signOutBtn.style.display= 'none';
        if (taskUnsub) taskUnsub();
        if (memberUnsub) memberUnsub();
        renderMembers([]);
        renderTasks([]);
        return;
      }
      // Create or load profile
      const uref = doc(db,'users',user.uid);
      const snap = await getDoc(uref);
      if (!snap.exists()){
        await setDoc(uref,{
          uid:user.uid,
          email:user.email,
          displayName:user.displayName,
          avatar:'üíñ',
          spaces:[], // user can join multiple spaces
          createdAt: serverTimestamp()
        });
      }
      const data = (await getDoc(uref)).data();
      userName.textContent = data.displayName || user.email;
      userAvatar.textContent = data.avatar || 'üíñ';
      profileEmoji.textContent = data.avatar || 'üíñ';
      profileName.textContent = data.displayName || user.email;
      profileEmail.textContent = data.email || '';
      signInBtn.style.display = 'none';
      signOutBtn.style.display= 'inline-flex';

      // Auto-join default space if none set
      if (!currentSpace){
        currentSpace = spaceCodeInput.value || 'day2day-default';
      }
      await ensureSpaceMembership(currentSpace);
      subscribeMembers(currentSpace);
      subscribeTasks(currentSpace, taskDate.value || todayStr());
    });

    // Avatar save
    saveAvatarBtn.onclick = async ()=>{
      if (!currentUser) return alert('Sign in first');
      const uref = doc(db,'users', currentUser.uid);
      await updateDoc(uref,{ avatar: emojiSelect.value });
      userAvatar.textContent = emojiSelect.value;
      profileEmoji.textContent = emojiSelect.value;
      alert('Saved!');
    };

    // Space join
    joinSpaceBtn.onclick = async ()=>{
      if (!currentUser) return alert('Sign in first');
      const code = (spaceCodeInput.value || '').trim();
      if (!code) return alert('Enter a space code');
      currentSpace = code;
      await ensureSpaceMembership(code);
      subscribeMembers(code);
      subscribeTasks(code, taskDate.value || todayStr());
    };

    async function ensureSpaceMembership(code){
      const sref = doc(db,'spaces', code);
      const s = await getDoc(sref);
      if (!s.exists()){
        await setDoc(sref,{ code, createdAt: serverTimestamp() });
      }
      // add/ensure member doc
      const mref = doc(db,'spaces', code, 'members', currentUser.uid);
      const u = await getDoc(doc(db,'users', currentUser.uid));
      const uData = u.data();
      await setDoc(mref,{
        uid: currentUser.uid,
        email: currentUser.email,
        displayName: uData.displayName || currentUser.email,
        avatar: uData.avatar || 'üíñ',
        joinedAt: serverTimestamp()
      }, { merge:true });
      // link space to user profile
      await updateDoc(doc(db,'users', currentUser.uid), {
        spaces: (uData.spaces || []).includes(code) ? uData.spaces : [ ...new Set([...(uData.spaces || []), code]) ]
      });
    }

    // Members live list
    function subscribeMembers(code){
      if (memberUnsub) memberUnsub();
      const q = query(collection(db,'spaces', code,'members'), orderBy('displayName'));
      memberUnsub = onSnapshot(q, snap=>{
        const members = snap.docs.map(d=>({ id:d.id, ...d.data()}));
        renderMembers(members);
      });
    }

    // Tasks live list filtered by date
    function subscribeTasks(code, dateStr){
      if (taskUnsub) taskUnsub();
      const q = query(
        collection(db,'spaces', code,'tasks'),
        where('date','==', dateStr),
        orderBy('createdAt')
      );
      taskUnsub = onSnapshot(q, snap=>{
        const tasks = snap.docs.map(d=>({ id:d.id, ...d.data()}));
        renderTasks(tasks);
      });
    }

    // Calendar controls
    taskDate.value = todayStr();
    todayBtn.onclick = ()=>{
      taskDate.value = todayStr();
      if (currentSpace) subscribeTasks(currentSpace, taskDate.value);
    };
    taskDate.onchange = ()=>{
      if (currentSpace) subscribeTasks(currentSpace, taskDate.value);
    };

    // Add task
    addTaskBtn.onclick = async ()=>{
      if (!currentUser) return alert('Sign in first');
      if (!currentSpace) return alert('Join a space first');
      const title = (taskTitle.value || '').trim();
      const description = (taskDesc.value || '').trim();
      const date = taskDate.value || todayStr();
      const assignEmail = (taskFor.value || '').trim();
      if (!title) return alert('Title required');
      let assignees = [];
      if (assignEmail) assignees = [assignEmail.toLowerCase()];
      await addDoc(collection(db,'spaces', currentSpace, 'tasks'),{
        title, description, date, assignees,
        done:false, feedback:'',
        createdBy: currentUser.uid,
        createdAt: serverTimestamp()
      });
      taskTitle.value = ''; taskDesc.value = ''; taskFor.value='';
    };

    // Toggle done/delete/feedback handlers
    taskList.addEventListener('change', async (e)=>{
      const id = e.target.getAttribute('data-id');
      if (id){
        const checked = e.target.checked;
        await updateDoc(doc(db,'spaces', currentSpace, 'tasks', id), { done: checked });
      }
      const fbId = e.target.getAttribute('data-fb');
      if (fbId){
        await updateDoc(doc(db,'spaces', currentSpace, 'tasks', fbId), { feedback: e.target.value });
      }
    });
    taskList.addEventListener('click', async (e)=>{
      const del = e.target.getAttribute('data-del');
      if (del){
        // soft delete: mark hidden (for safety rules); adapt to hard delete if allowed
        await updateDoc(doc(db,'spaces', currentSpace, 'tasks', del), { hidden: true });
      }
    });
  </script>
</body>
</html>
